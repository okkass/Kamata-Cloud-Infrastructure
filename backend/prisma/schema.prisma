// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated"
}

datasource db {
  provider = "mysql"
}

// ---------------------------------------------------------
//  ENUMS
// ---------------------------------------------------------

enum VmStatus {
  running
  stopped
  pending
}

enum RuleRoleType {
  inbound
  outbound
}

enum RuleProtocol {
  tcp
  udp
  icmp
  any
}

enum RuleAction {
  allow
  deny
}

// ---------------------------------------------------------
//  USER & AUTHENTICATION
// ---------------------------------------------------------

model User {
  id          BigInt    @id @default(autoincrement())
  uuid        String    @unique @default(uuid())
  name        String    @db.VarChar(256)
  email       String    @unique @db.VarChar(256)
  createdAt   DateTime  @default(now()) @map("created_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Quotas (0 for unlimited)
  cpuLimitCores  Int @default(0) @map("cpu_limit_cores")
  memoryLimitMb  Int @default(0) @map("memory_limit_mb")
  storageLimitGb Int @default(0) @map("storage_limit_gb")


  // Relations
  credentials     UserCredential?
  portfolios      Portfolio[]
  virtualMachines VirtualMachine[]
  securityGroups  SecurityGroup[]
  virtualNetworks VirtualNetwork[]
  operationLogs   OperationLog[]
  permission      Permission?

  @@map("users")
}

model UserCredential {
  userId         BigInt @id @map("user_id")
  hashedPassword String @map("hashed_password") @db.VarChar(256)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_credentials")
}

model Permission {
  id                    BigInt  @id @default(autoincrement())
  uuid                  String  @unique @default(uuid())
  isAdmin               Boolean @default(false) @map("is_admin")
  isImageAdmin          Boolean @default(false) @map("is_image_admin")
  isInstanceTypeAdmin   Boolean @default(false) @map("is_instance_type_admin")
  isVirtualMachineAdmin Boolean @default(false) @map("is_virtual_machine_admin")
  isNetworkAdmin        Boolean @default(false) @map("is_network_admin")
  isSecurityGroupAdmin  Boolean @default(false) @map("is_security_group_admin")
  isNodeAdmin           Boolean @default(false) @map("is_node_admin")

  // Foreign Keys
  userId BigInt  @unique @map("user_id")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("permissions")
}

model RefleshToken {
  id        BigInt   @id @default(autoincrement())
  token     Bytes   @unique @db.Binary(32) // 32バイトのバイナリデータ
  createdAt DateTime @default(now()) @map("created_at")
  expiredAt DateTime @map("expired_at")
  revokedAt DateTime? @map("revoked_at")
  userId    BigInt   @map("user_id")
}

model Portfolio {
  id        BigInt   @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  userId    BigInt   @map("user_id")

  // Relations
  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles PortfolioArticle[]

  @@map("portfolios")
}

model PortfolioArticle {
  id          BigInt   @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  title       String   @db.VarChar(256)
  createdAt   DateTime @default(now()) @map("created_at")
  portfolioId BigInt   @map("portfolio_id")

  // Relations
  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@map("portfolio_articles")
}

// ---------------------------------------------------------
//  COMPUTE
// ---------------------------------------------------------

model VirtualMachine {
  id        BigInt   @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  name      String   @db.VarChar(256)
  status    VmStatus @default(pending)
  cpu       Int
  memory    Int
  createdAt DateTime @default(now()) @map("created_at")

  // Foreign Keys
  nodeId  BigInt @map("node_id")
  imageId BigInt @map("image_id")
  userId  BigInt @map("user_id")

  // Relations
  node              Node                            @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  image             Image                           @relation(fields: [imageId], references: [id], onDelete: Cascade)
  user              User                            @relation(fields: [userId], references: [id], onDelete: Cascade)
  networkInterfaces NetworkInterface[]              
  attachedStorages  VirtualMachineAttachedStorage[]
  snapshots         Snapshot[]
  securityGroups    VirtualMachineSecurityGroup[]
  backups           Backup[]

  @@map("virtual_machines")
}

model Node {
  id        BigInt   @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  name      String   @db.VarChar(256)
  ipAddress String   @map("ip_address") @db.VarChar(15)
  isAdmin   Boolean  @default(false) @map("is_admin")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  virtualMachines VirtualMachine[]
  images          Image[]

  @@map("nodes")
}

model Image {
  id          BigInt   @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  name        String   @db.VarChar(256)
  description String?  @db.Text
  size        Int
  createdAt   DateTime @default(now()) @map("created_at")
  ownNodeId   BigInt   @map("own_node_id")

  // Relations
  ownNode         Node             @relation(fields: [ownNodeId], references: [id], onDelete: Cascade)
  virtualMachines VirtualMachine[]

  @@map("images")
}

model InstanceType {
  id         BigInt   @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  name       String   @db.VarChar(256)
  cpuCore    Int      @map("cpu_core")
  memorySize Int      @map("memory_size")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("instance_types")
}

model Middleware {
  id        BigInt   @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  name      String   @db.VarChar(256)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("middlewares")
}

// ---------------------------------------------------------
//  STORAGE
// ---------------------------------------------------------

model StoragePool {
  id               BigInt   @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  name             String   @db.VarChar(256)
  hasNetworkAccess Boolean  @default(false) @map("has_network_access")
  availableSize    BigInt   @map("available_size")
  totalSize        BigInt   @map("total_size")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  virtualStorages VirtualStorage[]

  @@map("storage_pools")
}

model VirtualStorage {
  id            BigInt   @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  name          String   @db.VarChar(256)
  size          BigInt
  createdAt     DateTime @default(now()) @map("created_at")
  storagePoolId BigInt   @map("storage_pool_id")

  // Relations
  storagePool StoragePool                     @relation(fields: [storagePoolId], references: [id], onDelete: Cascade)
  attachedTo  VirtualMachineAttachedStorage[]
  backups     Backup[]

  @@map("virtual_storages")
}

// Many-to-Many explicit relation table for VM <-> Storage
model VirtualMachineAttachedStorage {
  virtualMachineId BigInt @map("virtual_machine_id")
  virtualStorageId BigInt @map("virtual_storage_id")
  path             String @db.VarChar(255)

  // Relations
  virtualMachine VirtualMachine @relation(fields: [virtualMachineId], references: [id], onDelete: Cascade)
  virtualStorage VirtualStorage @relation(fields: [virtualStorageId], references: [id], onDelete: Cascade)

  @@id([virtualMachineId, virtualStorageId])
  @@map("virtual_machine_attached_storage")
}

model Backup {
  id                     BigInt   @id @default(autoincrement())
  uuid                   String   @unique @default(uuid())
  name                   String   @db.VarChar(256)
  description            String?  @db.Text
  size                   Int
  createdAt              DateTime @default(now()) @map("created_at")
  virtualStorageId       BigInt   @map("virtual_storage_id")
  sourceVirtualMachineId BigInt   @map("source_virtual_machine_id")

  // Relations
  virtualStorage       VirtualStorage @relation(fields: [virtualStorageId], references: [id], onDelete: Cascade)
  sourceVirtualMachine VirtualMachine @relation(fields: [sourceVirtualMachineId], references: [id], onDelete: Restrict)

  @@map("backups")
}

model Snapshot {
  id                     BigInt   @id @default(autoincrement())
  uuid                   String   @unique @default(uuid())
  name                   String   @db.VarChar(256)
  description            String?  @db.Text
  createdAt              DateTime @default(now()) @map("created_at")
  targetVirtualMachineId BigInt   @map("target_virtual_machine_id")

  // Relations
  targetVirtualMachine VirtualMachine @relation(fields: [targetVirtualMachineId], references: [id], onDelete: Cascade)

  @@map("snapshots")
}

// ---------------------------------------------------------
//  NETWORK
// ---------------------------------------------------------

model VirtualNetwork {
  id        BigInt   @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  name      String   @db.VarChar(256)
  cidr      String   @db.VarChar(15)
  createdAt DateTime @default(now()) @map("created_at")
  userId    BigInt   @map("user_id")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subnets Subnet[]

  @@map("virtual_networks")
}

model Subnet {
  id               BigInt   @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  name             String   @db.VarChar(256)
  cidr             String   @db.VarChar(15)
  createdAt        DateTime @default(now()) @map("created_at")
  virtualNetworkId BigInt   @map("virtual_network_id")

  // Relations
  virtualNetwork    VirtualNetwork     @relation(fields: [virtualNetworkId], references: [id], onDelete: Cascade)
  networkInterfaces NetworkInterface[]

  @@map("subnets")
}

model NetworkInterface {
  id               BigInt   @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  name             String   @db.VarChar(256)
  ipAddress        String   @map("ip_address") @db.VarChar(15)
  macAddress       String   @map("mac_address") @db.VarChar(15)
  createdAt        DateTime @default(now()) @map("created_at")
  subnetId         BigInt   @map("subnet_id")
  virtualMachineId BigInt   @map("virtual_machine_id")

  // Relations
  subnet         Subnet         @relation(fields: [subnetId], references: [id], onDelete: Cascade)
  virtualMachine VirtualMachine @relation(fields: [virtualMachineId], references: [id], onDelete: Cascade)

  @@map("network_interfaces")
}

model SecurityGroup {
  id          BigInt   @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  name        String   @db.VarChar(256)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  userId      BigInt   @map("user_id")

  // Relations
  user            User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rules           SecurityRule[]
  virtualMachines VirtualMachineSecurityGroup[]

  @@map("security_groups")
}

model SecurityRule {
  id              BigInt       @id @default(autoincrement())
  uuid            String       @unique @default(uuid())
  name            String       @db.VarChar(256)
  roleType        RuleRoleType @map("role_type")
  port            Int
  protocol        RuleProtocol @map("rule_protocol")
  targetIp        String       @map("target_ip") @db.VarChar(15)
  action          RuleAction
  createdAt       DateTime     @default(now()) @map("created_at")
  securityGroupId BigInt       @map("security_group_id")

  // Relations
  securityGroup SecurityGroup @relation(fields: [securityGroupId], references: [id], onDelete: Cascade)

  @@map("security_rules")
}

// Many-to-Many explicit relation table for VM <-> SecurityGroup
model VirtualMachineSecurityGroup {
  virtualMachineId BigInt @map("virtual_machine_id")
  securityGroupId  BigInt @map("security_group_id")

  // Relations
  virtualMachine VirtualMachine @relation(fields: [virtualMachineId], references: [id], onDelete: Cascade)
  securityGroup  SecurityGroup  @relation(fields: [securityGroupId], references: [id], onDelete: Cascade)

  @@id([virtualMachineId, securityGroupId])
  @@map("virtual_machine_security_groups")
}

// ---------------------------------------------------------
//  LOGGING
// ---------------------------------------------------------

model OperationLog {
  id         BigInt   @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  action     String // "操作内容"
  targetType String   @map("target_type") // "対象リソース名"
  targetUuid String   @map("target_uuid") // "対象リソースUUID" (String since UUID is binary/string)
  payload    Json?    // "操作内容の詳細情報"
  result     String // "SUCCESS/FAILURE"
  ipAddress  String   @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")
  userId     BigInt?  @map("user_id")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  taskLogs TaskLog[]
  @@map("operation_logs")
}

model TaskLog {
  id        BigInt   @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  taskName  String   @map("task_name") @db.VarChar(256)
  status    String
  message   Json?   // "ログメッセージや詳細情報"
  createdAt DateTime @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")
  operationLogId BigInt @map("operation_log_id")

  // Relations
  operationLog  OperationLog @relation(fields: [operationLogId], references: [id], onDelete: Cascade)
  @@map("task_logs")
}
